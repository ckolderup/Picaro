<!DOCTYPE html>  <html> <head>   <title>game_event.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="action_guard.html">                 action_guard.coffee               </a>                                           <a class="source" href="counter.html">                 counter.coffee               </a>                                           <a class="source" href="game_event.html">                 game_event.coffee               </a>                                           <a class="source" href="inventory.html">                 inventory.coffee               </a>                                           <a class="source" href="item.html">                 item.coffee               </a>                                           <a class="source" href="picaro.html">                 picaro.coffee               </a>                                           <a class="source" href="room.html">                 room.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               game_event.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Game Events</h1>

<p>The primary way in which the gameworld responds to player action is via events.  Currently, an "after" event is all that's specified, but at some point we will likely add "before" events or events that occur after some period of time has elapsed. The idea is that an event ID can be attached to any action (a verb called on an item) as its "after" property.  When an action (generally, anything of the form "verb + noun") is performed, the event will be looked up and triggered here if it is one of the known types.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>First we declare our dependencies on Item, Inventory and Room, as well as the usual suspects, $ and _.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span> <span class="s2">&quot;jquery&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;inventory&quot;</span><span class="p">,</span> <span class="s2">&quot;room&quot;</span><span class="p">,</span> <span class="s2">&quot;vendor/underscore&quot;</span> <span class="p">],</span> <span class="nf">($, Item, Inventory, Room) -&gt;</span>
  <span class="nv">GameEvent =</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We take the array of events from the game JSON and store them, hashed by ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">init: </span><span class="nf">(events) -&gt;</span>
      <span class="nx">@allById</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">event</span> <span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">events</span> <span class="k">if</span> <span class="nx">events</span>

    <span class="nv">allById: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Types</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Simply add a new message to the game's main display.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">updateStatus: </span><span class="nf">(gameEvent) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The player actually takes the item. Item listens to <code>immediateTake</code> and adds to the Inventory with not further checks.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">takeItem: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;immediateTake&quot;</span><span class="p">,</span> <span class="nx">gameEvent</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Removes the item from inventory and sets its location to the current room, effectively dropping it there.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dropItem: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nx">Inventory</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">gameEvent</span><span class="p">.</span><span class="nx">item</span>
      <span class="nv">gameEvent.item.location = </span><span class="nx">Room</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;resetMenus&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Remove the item from the game and set its location to nil, effectively removing it from the gameworld. It's still available in the Item list if it needs to pop back into existence later.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">removeItem: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nx">Inventory</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">gameEvent</span><span class="p">.</span><span class="nx">item</span>
      <span class="nx">Item</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">gameEvent</span><span class="p">.</span><span class="nx">item</span><span class="p">].</span><span class="nv">location = </span><span class="kc">undefined</span> 
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;resetMenus&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Take the item specified and replace the named attribute with a new value; this might be just a string replacement, or swapping in a complex object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">updateAttribute: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nx">Item</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">gameEvent</span><span class="p">.</span><span class="nx">item</span><span class="p">][</span><span class="nx">gameEvent</span><span class="p">.</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gameEvent</span><span class="p">.</span><span class="nx">newValue</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;resetMenus&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>A winner is you!  We need some sort of joy-enhancing user experience here, as there's nothing special going on here at the moment.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">instantVictory: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;updateStatus&quot;</span><span class="p">,</span> <span class="s2">&quot;THE GAME IS WON&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Entirely blows away the <code>items</code> specified in the gameEvent which is passed in, and replaces them with the <code>newItem</code>.  Should work with items in the Inventory, in the room, or a mix between the two.  If any of the old items were in the user's Inventory, the new item will appear there as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">replaceItems: </span><span class="nf">(gameEvent) -&gt;</span>
      <span class="nv">oldItemsWereInInventory = </span><span class="kc">false</span>
      <span class="nx">_</span><span class="p">(</span><span class="nx">gameEvent</span><span class="p">.</span><span class="nx">items</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(itemId, index) -&gt;</span>
        <span class="nv">oldItemsWereInInventory = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">Inventory</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
        <span class="k">delete</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">itemId</span><span class="p">]</span> <span class="k">if</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">itemId</span><span class="p">]</span>
      <span class="nv">newItem = </span><span class="nx">gameEvent</span><span class="p">.</span><span class="nx">newItem</span>
      <span class="nv">newItem.location = </span><span class="nx">Room</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">Item</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">newItem</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newItem</span>
      <span class="nx">Inventory</span><span class="p">.</span><span class="nx">add</span> <span class="nx">newItem</span>  <span class="k">if</span> <span class="nx">oldItemsWereInInventory</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;resetMenus&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>DOM Event binding</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This is the generic event listener for all Game Events. An 'action' (verb + noun) object is passed along, and if the <code>after</code> event therein exists in <code>@allById</code>, it's passed to the function specified by its type. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">bind</span> <span class="s2">&quot;gameEvent&quot;</span><span class="p">,</span> <span class="nf">(e, action) -&gt;</span>
    <span class="k">if</span> <span class="nv">afterEvent = </span><span class="nx">GameEvent</span><span class="p">.</span><span class="nx">allById</span><span class="p">[</span><span class="nx">action</span><span class="p">[</span><span class="s2">&quot;after&quot;</span><span class="p">]]</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span> <span class="s2">&quot;updateStatus&quot;</span><span class="p">,</span> <span class="nx">afterEvent</span><span class="p">.</span><span class="nx">message</span> <span class="k">if</span> <span class="nx">afterEvent</span><span class="p">.</span><span class="nx">message</span>
      <span class="nx">GameEvent</span><span class="p">[</span><span class="nx">afterEvent</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="nx">afterEvent</span>
      </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Return the GameEvent module, so it can be required by others.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">GameEvent</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 